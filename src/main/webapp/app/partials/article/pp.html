<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script src="/app/libs/jquery/jquery.js"></script>
    <script src="/app/libs/angular/angular.js"></script>
    <script src="/app/libs/select2/select2.js"></script>
    <script src="/app/libs/angular-ui-select2/src/select2.js"></script>
    <script>
        'use strict';

        var app = angular.module('pp', ['ui.select2']);

        app.controller('ppctrl', function($scope, $http) {
            $scope.article = {};
            $http.get("/api/article/1").then(function(response) {
                $scope.article = response.data;
            });

            $scope.persons = [];
            $http.get("/api/person/").then(function(response) {
                $scope.persons = response.data;
            });

            $scope.renderPerson = function(person) {
                return person.first_name + ' ' + person.last_name
            };
        });

        app.directive('multiPicker', function() {
            return {
                restrict: 'E',
                templateUrl: '/app/partials/article/multiPicker.html',
                scope: {
                    items: '=',
                    target: '=',
                    renderer: '='
                },
                link: function(scope, element, attrs) {
                    scope.selectedIDs = [];
                    scope.selectedIDs = scope.target.map(function(o){
                        return o.id;
                    });

                    scope.lookup = {};
                    scope.items.forEach(function(person){
                        scope.lookup[person.id] = person;
                    });

                    scope.$watch('selectedIDs', function() {
                        scope.target = scope.selectedIDs.map(function(id) {
                            return scope.lookup[id];
                        });
                    });
                }
            };
        });
    </script>

    <link rel="stylesheet" href="/app/libs/select2/select2.css">
    <style>
        multi-picker .select2-container {
            width: 10em;
        }
        li.select2-search-choice {
            clear: both;
        }
    </style>
</head>
<body ng-app="pp" ng-controller="ppctrl">
<multi-picker items="persons" target="article.journalists" renderer="renderPerson"></multi-picker>

<div style="clear: both;"></div>
{{ article.journalists }}

</body>
</html>